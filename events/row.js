const cron = require('node-cron');
const { EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const { roweventnotificationrom } = require('../config.json');

function setupReminders(client) {
    
    const activities = [
        ['æ é‡‘å¤§ç›œ', 1, '12:00', '19:00','æ¯é€±ä¸€ã€äº”12:00â€“19:30,æ é‡‘å¤§ç›œå€‘æœƒåœ¨é€™æ®µæ™‚é–“çš„äººä¾µå…¬æœƒ,æ¯è¼ªå…¥ä¾µæŒçºŒ30åˆ†é˜ã€‚åŒä¸€å…¬æœƒçš„å†’éšªè€…å€‘å¯ä»¥çµ„æˆ3è‡³ 5äººå°éšŠå‰å¾€é˜»æ“Šå…¥ä¾µçš„æ é‡‘å¤§ç›—å€‘,ä¸€èµ·å®ˆè­·å…¬æœƒè³‡é‡‘!æ¯å¤©å‰ 3æ¬¡æŒ‘æˆ°å¯ä»¥ç²å¾—å…¨é¡çå‹µã€‚19:00æ™‚è‹¥æ“Šé€€æ‰€æœ‰å…¥ä¾µçš„å¤§ç›—, å°‡æœƒå¼•ä¾†æ é‡‘çµ±é ˜,æ“Šæ•—å®ƒå¾Œå°±èƒ½ç²å¾—è±åšçš„çå‹µå’Œå…¬æœƒç©åˆ†å–” !'],
        ['å…¬æœƒå®´æœƒ', 2, '21:00', '21:20','å¯ä»¥åœ¨å·¥æœƒå ´æ™¯èˆ‡æˆå“¡ä¸€èµ·ç­”é¡Œã€åƒèœï¼Œæ­¡æ¨‚å¤šå¤š'],
        ['å…¬æœƒè¯è³½', 2, '21:30', '21:55','å¤§å‹æˆ°å ´,ç™¾äººå°æŠ—!å…¬æœƒä¹‹é–“åˆ†çµ„å°æŠ—,é€éåˆè³½ã€è¤‡è³½ã€æ±ºè³½çˆ­å¥ªå† è»!å…¬æœƒå°‡ç²å¾—å¤§é‡æˆ°åˆ©å“,æˆ°åˆ©å“çš„æ‹è³£æ‰€å¾—,æœƒåˆ†ç´…çµ¦æ‰€æœ‰åƒæˆ°ç©å®¶ã€‚'],
        ['å…¬æœƒè¯è³½', 2, '22:00', '22:25','å¤§å‹æˆ°å ´,ç™¾äººå°æŠ—!å…¬æœƒä¹‹é–“åˆ†çµ„å°æŠ—,é€éåˆè³½ã€è¤‡è³½ã€æ±ºè³½çˆ­å¥ªå† è»!å…¬æœƒå°‡ç²å¾—å¤§é‡æˆ°åˆ©å“,æˆ°åˆ©å“çš„æ‹è³£æ‰€å¾—,æœƒåˆ†ç´…çµ¦æ‰€æœ‰åƒæˆ°ç©å®¶ã€‚'],
        ['ç•°ç•Œå…¥ä¾µ', 3, '10:30', '05:00','æ¯é€±ä¸‰ã€æ—¥çš„10:30è‡³éš”å¤©5:00,ç•°ç•Œé­”ç‰©æœƒåœ¨æ¯å€‹åŠé»é‡ç”Ÿ,æ¯æ¬¡æŒçºŒ30åˆ†é˜ã€‚'], 
        ['é‚ªæƒ¡å¯¶ç®±', 3, '08:00', '23:00','æ´»å‹•æœŸé–“8é»åˆ°23é»,é‚ªæƒ¡å¯¶ç®±æœƒåœ¨æœŸé–“çš„æ•´é»å’Œ30åˆ†åœ¨é‡å¤–é‡ç”Ÿ,æŒçºŒ20åˆ†é˜,å†’éšªè€…å¯çµ„æˆ3è‡³5äººå°éšŠå‰å¾€æŒ‘æˆ°,ç²å¾—è±åšçå‹µ!'],
        ['é å¤éºè·¡', 3, '21:30', '22:15','æ´»å‹•å‰15åˆ†é˜ç‚ºå ±åæ™‚é–“,ä¸å ±åå°‡ç„¡æ³•åƒèˆ‡æ´»å‹•ã€‚æ´»å‹•åœ°åœ–åˆ†ç‚ºä¸‰å±¤,æ‰¾åˆ°é‘°åŒ™æ–¹å¯é€²å…¥ä¸‹ä¸€å±¤,æ“Šæ•—æ€ªç‰©æˆ–å…¶ä»–æœ‰é‘°åŒ™çš„ç©å®¶å¯ä»¥ç²å¾—é‘°åŒ™ã€‚'],
        ['é¡åƒä¸–ç•Œ', 4, '21:00', '21:15','å‰å¾€å…¬æœƒé€²å…¥é¡åƒä¸–ç•Œå®ŒæˆæŒ‘æˆ°'],
        ['è¿·éœ§æ£®æ—', 4, '21:30', '21:45','å¯¶è—æ»¿æ»¿çš„æ£®æ—è£¡å±æ©Ÿå››ä¼,æ‰€æœ‰å†’éšªå®¶éƒ½è“„å‹¢å¾…ç™¼,æ˜¯æ™‚å€™å‡ºæ“Šè´å¾—å±¬æ–¼ä½ å€‘çš„å¯¶è—äº†!'],
        ['å…¬æœƒè¯è³½', 4, '22:00', '22:25','å¤§å‹æˆ°å ´,ç™¾äººå°æŠ—!å…¬æœƒä¹‹é–“åˆ†çµ„å°æŠ—,é€éåˆè³½ã€è¤‡è³½ã€æ±ºè³½çˆ­å¥ªå† è»!å…¬æœƒå°‡ç²å¾—å¤§é‡æˆ°åˆ©å“,æˆ°åˆ©å“çš„æ‹è³£æ‰€å¾—,æœƒåˆ†ç´…çµ¦æ‰€æœ‰åƒæˆ°ç©å®¶ã€‚'],
        ['æ é‡‘å¤§ç›œ', 5, '12:00', '19:00','æ¯é€±ä¸€ã€äº”12:00â€“19:30,æ é‡‘å¤§ç›œå€‘æœƒåœ¨é€™æ®µæ™‚é–“çš„äººä¾µå…¬æœƒ,æ¯è¼ªå…¥ä¾µæŒçºŒ30åˆ†é˜ã€‚åŒä¸€å…¬æœƒçš„å†’éšªè€…å€‘å¯ä»¥çµ„æˆ3è‡³ 5äººå°éšŠå‰å¾€é˜»æ“Šå…¥ä¾µçš„æ é‡‘å¤§ç›—å€‘,ä¸€èµ·å®ˆè­·å…¬æœƒè³‡é‡‘!æ¯å¤©å‰ 3æ¬¡æŒ‘æˆ°å¯ä»¥ç²å¾—å…¨é¡çå‹µã€‚19:00æ™‚è‹¥æ“Šé€€æ‰€æœ‰å…¥ä¾µçš„å¤§ç›—, å°‡æœƒå¼•ä¾†æ é‡‘çµ±é ˜,æ“Šæ•—å®ƒå¾Œå°±èƒ½ç²å¾—è±åšçš„çå‹µå’Œå…¬æœƒç©åˆ†å–” !'],
        ['å…”å…”é€å–œ', 5, '21:00', '21:30','å“å‘€å‘€!å¯æ„›çš„ç˜‹å…”å¯¶å¯¶ä¾†çµ¦å¤§å®¶é€ç¦åˆ©å•¦!ä»–æœƒéš¨æ©ŸæŒ‘é¸50åå¹¸é‹ç©å®¶ä¾†æ¯”è³½,ç²å¾—ç¬¬ä¸€åçš„å¹¸é‹å…’å°‡ç²å¾—3280æ˜ŸçŸ³ç­‰å¤§ç, æ²’æœ‰è¢«é¸ä¸­çš„ç©å®¶ä¹Ÿå¯ä»¥åƒèˆ‡æŠ¼æ³¨æ‹¿çå‹µå–”~=W='],
        ['éºå¿˜ä¹‹åœ°', 6, '12:00', '23:59','æœ‰ä¸€ç‰‡é€£æ¥æ®­å±æ´ç©´çš„éºå¿˜ä¹‹åœ°,æ“šèªªæœƒåœ¨é€±æœ«æ•£ç™¼å‡ºå¼·å¤§çš„äº¡éˆæ°£æ¯,å‰å»æŒ‘æˆ°çš„å†’éšªè€…å¯ä»¥ç²å¾—å¤§é‡ç¶“é©—å€¼ã€‚'],
        ['é‚ªæƒ¡å¯¶ç®±', 6, '08:00', '23:00','æ´»å‹•æœŸé–“8é»åˆ°23é»,é‚ªæƒ¡å¯¶ç®±æœƒåœ¨æœŸé–“çš„æ•´é»å’Œ30åˆ†åœ¨é‡å¤–é‡ç”Ÿ,æŒçºŒ20åˆ†é˜,å†’éšªè€…å¯çµ„æˆ3è‡³5äººå°éšŠå‰å¾€æŒ‘æˆ°,ç²å¾—è±åšçå‹µ!'],
        ['æµå…‰ç§˜å¢ƒ', 6, '08:00', '23:59','æ´»å‹•æœŸé–“å¯ä»¥å‰å¾€æµå…‰ç§˜å¢ƒä¸­é€²è¡Œæ¢ç´¢,æœŸé–“æœƒä¸æ–·åˆ·æ–°é­”ç‰©, ç©å®¶å¯ä»¥åœ¨ç§˜å¢ƒä¸­è‡ªç”±å°æˆ°!'],
        ['ç¥é¸ä¹‹çˆ­', 6, '21:00', '22:00','ç«¶æŠ€æ´»å‹•â€”ç¥é¸ä¹‹çˆ­å³å°‡é–‹å•Ÿ!åœ¨é€™è£¡ä½ å°‡èˆ‡åŒè·æ¥­çš„é«˜æ‰‹ä¸€è¼ƒé«˜ä¸‹,å”¯æœ‰æœ€å¼·è€…,æ‰èƒ½åŠ å†•ã€Œç¥é¸ä¹‹å­ã€çš„ç„¡ä¸Šæ¦®å…‰!'],
        ['ç•°ç•Œå…¥ä¾µ', 0, '10:30', '05:00','æ¯é€±ä¸‰ã€æ—¥çš„10:30è‡³éš”å¤©5:00,ç•°ç•Œé­”ç‰©æœƒåœ¨æ¯å€‹åŠé»é‡ç”Ÿ,æ¯æ¬¡æŒçºŒ30åˆ†é˜ã€‚'], 
        ['é‚ªæƒ¡å¯¶ç®±', 0, '08:00', '23:00','æ´»å‹•æœŸé–“8é»åˆ°23é»,é‚ªæƒ¡å¯¶ç®±æœƒåœ¨æœŸé–“çš„æ•´é»å’Œ30åˆ†åœ¨é‡å¤–é‡ç”Ÿ,æŒçºŒ20åˆ†é˜,å†’éšªè€…å¯çµ„æˆ3è‡³5äººå°éšŠå‰å¾€æŒ‘æˆ°,ç²å¾—è±åšçå‹µ!'],
        ['é»‘ç™½æˆ°å¢ƒ', 0, '19:00', '21:00','é»‘ç™½æˆ°å¢ƒç”±å…¬æœƒç®¡ç†é–‹å•Ÿ,æ‰€æœ‰æˆå“¡å‡å¯åƒèˆ‡æŒ‘æˆ°ã€‚é€šé—œæ˜Ÿç´šé›£åº¦å…¬æœƒå°‡ç²å¾—å¤§é‡æˆ°åˆ©å“ã€‚æˆ°åˆ©å“çš„æ‹è³£æ‰€å¾—,æœƒåˆ†ç´…çµ¦æ‰€æœ‰åƒæˆ°ç©å®¶ã€‚']
    ];

    const weekNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

    // 1ï¸âƒ£ æ¯å¤© 05:00 ç™¼é€ç•¶æ—¥æ´»å‹•æ¸…å–® (å«é€£çµæŒ‰éˆ•)
    cron.schedule('0 5 * * *', async () => {
        const today = new Date();
        const dayOfWeek = today.getDay();
        const todayActivities = activities.filter(act => act[1] === dayOfWeek);

        if (todayActivities.length > 0) {
            let listText = todayActivities.map((act, i) => {
                const isCross = parseInt(act[3].split(':')[0]) < parseInt(act[2].split(':')[0]);
                return `**${i + 1}. ${act[0]}**â”” æ™‚é–“ï¼š${act[2]} ~ ${isCross ? 'éš”æ—¥' : ''}${act[3]}`;
            }).join('\n\n');

            const dateStr = today.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            
            

            const row = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setEmoji('<:channels4_profileremovebgpreview:1470963994780242012>') // é€™è£¡å¡«å…¥ä½ çš„è‡ªå®šç¾© Emoji ID
                        .setLabel('ç©å®¶ç¤¾ç¾¤ç°½åˆ°')
                        .setURL('https://forum.gnjoy.hk/forum/index.html?customFrom=global-event&gameId=386&op_scid=8BrNw6rilsiugSH6InXLV&srtl=3276.0.0.0#/shop')
                        .setStyle(ButtonStyle.Link),
                    new ButtonBuilder()
                        .setEmoji('ğŸ§§') 
                        .setLabel('æ–°å¹´é›†å¡æŠ½å¥½ç¦®')
                        .setURL('https://s.gnjoy.hk/row_card_newyear/wswauu6')
                        .setStyle(ButtonStyle.Link)
    );

            const channel = await client.channels.fetch(roweventnotificationrom);
            if (channel) {
                const embed = new EmbedBuilder()
                    .setTitle(`ğŸ“… ${dateStr} (${weekNames[dayOfWeek]}) ç•¶æ—¥æ´»å‹•ç¸½è¦½`)
                    .setDescription(listText)
                    .setColor('#3498db')
                    .setTimestamp();

                await channel.send({ embeds: [embed], components: [row] });
            }
        }
    });

    activities.forEach(([name, day, start, end, info]) => {
        const [sH, sM] = start.split(':').map(Number);
        const [eH, eM] = end.split(':').map(Number);

        // --- è¨ˆç®—æå‰ 5 åˆ†é˜çš„æ™‚é–“ ---
        let startRemH = sH;
        let startRemM = sM - 5;
        if (startRemM < 0) {
            startRemM += 60;
            startRemH -= 1;
            if (startRemH < 0) startRemH = 23; 
        }

        // 2ï¸âƒ£ æ´»å‹•é–‹å§‹é€šçŸ¥ (æå‰ 5 åˆ†é˜)
        cron.schedule(`${startRemM} ${startRemH} * * ${day}`, async () => {
            const description = `**æ´»å‹•ä»‹ç´¹ï¼š**\n${info}\n\n**æ­£å¼é–‹å§‹æ™‚é–“ï¼š** \`${start}\`\n**çµæŸæ™‚é–“ï¼š** \`${end}\``;
            await sendEmbed(client, `ğŸ”” æ´»å‹•å³å°‡åœ¨ 5åˆ†é˜ å¾Œé–‹å§‹ï¼š${name}`, description, '#00ff00');
        });

        // 3ï¸âƒ£ æ´»å‹•çµæŸæé†’é‚è¼¯
        let duration = (eH * 60 + eM) - (sH * 60 + sM);
        if (duration < 0) duration += 1440;

        const isCrossDay = eH < sH;

        if (isCrossDay) {
            // è·¨æ—¥æ´»å‹•ï¼š23:00 é€šçŸ¥
            cron.schedule(`0 23 * * ${day}`, async () => {
                const description = `ä»Šæ—¥çš„ **${name}** æ´»å‹•å³å°‡çµæŸï¼Œè«‹è¨˜å¾—åœ¨éš”æ—¥ 05:00 å‰å®Œæˆã€‚`;
                await sendEmbed(client, `â° è·¨æ—¥æ´»å‹•æé†’ï¼š${name}`, description, '#ff0000');
            });
        } else if (duration >= 60) {
            // éè·¨æ—¥ä¸”è¶…éä¸€å°æ™‚ï¼šæå‰ä¸€å°æ™‚é€šçŸ¥
            let endRemH = eH - 1;
            cron.schedule(`${eM} ${endRemH} * * ${day}`, async () => {
                const description = `**${name}** æ´»å‹•å°‡åœ¨ä¸€å°æ™‚å¾ŒçµæŸã€‚\næ­£å¼çµæŸæ™‚é–“ï¼š\`${end}\``;
                await sendEmbed(client, `â° æ´»å‹•çµæŸæé†’ï¼š${name}`, description, '#ff0000');
            });
        }
    });
}

async function sendEmbed(client, title, desc, color) {
    try {
        const channel = await client.channels.fetch(roweventnotificationrom);
        if (channel) {
            const embed = new EmbedBuilder()
                .setTitle(title)
                .setDescription(desc)
                .setColor(color)
                .setTimestamp();
            await channel.send({ embeds: [embed] });
        }
    } catch (err) { console.error("æé†’ç™¼é€å¤±æ•—:", err); }
}

module.exports = { setupReminders };